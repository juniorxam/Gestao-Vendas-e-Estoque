<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ControlVendas Premium - Gestão Completa</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #0da271;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;
            --header-bg: #111827;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --header-bg: #020617;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding-top: 70px; /* Espaço para o header fixo */
        }

        /* Header e Navegação Superior */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--header-bg);
            color: #ffffff;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid #374151;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo i {
            margin-right: 10px;
            color: var(--primary);
        }

        .premium-badge {
            font-size: 0.7rem;
            background: var(--primary);
            padding: 2px 5px;
            border-radius: 10px;
            margin-left: 5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .user-info {
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .user-info img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-left: 10px;
            border: 2px solid var(--primary);
        }

        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Navegação Principal */
        .nav {
            display: flex;
            overflow-x: auto;
            background-color: var(--header-bg);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #d1d5db;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background-color: #1f2937;
            color: #ffffff;
            border-bottom: 3px solid var(--primary);
        }

        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Conteúdo Principal */
        .main-content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tabs Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .dashboard-card.receita::before { background-color: var(--success); }
        .dashboard-card.custo::before { background-color: var(--danger); }
        .dashboard-card.lucro::before { background-color: var(--info); }
        .dashboard-card.vendas::before { background-color: var(--purple); }
        .dashboard-card.meta::before { background-color: var(--warning); }

        .dashboard-card h3 {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .dashboard-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .dashboard-card i {
            margin-right: 10px;
            color: var(--primary);
        }
        
        /* Dashboard Cards com cores */
        .dashboard-card.receita .value { color: var(--success); }
        .dashboard-card.custo .value { color: var(--danger); }
        .dashboard-card.lucro .value { color: var(--info); }
        .dashboard-card.vendas .value { color: var(--purple); }
        .dashboard-card.meta .value { color: var(--warning); }

        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.receita { background-color: var(--success); }
        .progress-fill.meta { background-color: var(--warning); }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chart-card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Cards Genéricos (para formulários e tabelas) */
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.5rem;
            color: var(--text-color);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .card h2 i {
            margin-right: 10px;
        }

        /* Formulário */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-muted);
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        /* Tabela */
        .table-responsive {
            overflow-x: auto;
        }

        .tabela-servicos {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tabela-servicos th, .tabela-servicos td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .tabela-servicos th {
            background-color: var(--bg-color);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .tabela-servicos tbody tr:hover {
            background-color: var(--bg-color);
        }

        /* Botões de Ação na Tabela */
        .table-actions button {
            background: none;
            border: none;
            color: var(--info);
            cursor: pointer;
            margin-right: 8px;
            font-size: 1rem;
        }

        .table-actions button:hover {
            opacity: 0.8;
        }

        .table-actions button.delete {
            color: var(--danger);
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
            color: white;
        }

        .status-badge.em-andamento { background-color: var(--warning); }
        .status-badge.finalizado { background-color: var(--success); }
        .status-badge.cancelado { background-color: var(--danger); }
        .status-badge.pendente { background-color: var(--danger); }
        .status-badge.parcial { background-color: var(--warning); }
        .status-badge.pago { background-color: var(--success); }

        /* Filtros */
        .filtros-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filtro-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }

        .filtro-item label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-muted);
        }

        .filtro-item select, .filtro-item input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        /* Notificações */
        #notification-area {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
        }

        .notification {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.4s, transform 0.4s;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 400px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.sucesso { border-left: 5px solid var(--success); }
        .notification.erro { border-left: 5px solid var(--danger); }
        .notification.aviso { border-left: 5px solid var(--warning); }
        .notification.info { border-left: 5px solid var(--info); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Abas internas */
        .tabs-internal {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-internal {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-internal.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }

        /* Estoque */
        .estoque-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .estoque-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
        }

        .estoque-card.baixo {
            border-left-color: var(--danger);
        }

        .estoque-card h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .estoque-card .quantidade {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .estoque-card .alerta {
            font-size: 0.8rem;
            color: var(--danger);
            font-weight: 600;
        }

        /* Lembretes */
        .lembrete-item {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lembrete-item .info {
            flex-grow: 1;
        }

        .lembrete-item .acoes {
            display: flex;
            gap: 10px;
        }

        /* Media Queries para Responsividade */
        @media (max-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 120px; /* Mais espaço para header em duas linhas */
            }
            
            .header-top {
                flex-wrap: wrap;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background-color: var(--header-bg);
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .nav.active {
                display: flex;
            }
            
            .nav-item {
                padding: 15px 20px;
                border-bottom: 1px solid #374151;
                border-left: 4px solid transparent;
            }
            
            .nav-item.active {
                border-left: 4px solid var(--primary);
                border-bottom: 1px solid #374151;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .table-responsive {
                width: 100%;
                overflow-x: scroll;
            }

            .filtros-container {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .header-actions .user-info span {
                display: none; /* Esconde texto em mobile */
            }
            
            #notification-area {
                top: 130px;
                right: 10px;
                left: 10px;
            }
            
            .notification {
                max-width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .dashboard-card {
                padding: 15px;
            }
            
            .chart-card {
                padding: 15px;
            }
            
            .estoque-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    
    <!-- Header com Navegação Superior -->
    <header class="header">
        <div class="header-top">
            <div class="logo">
                <i class="fas fa-crown"></i> ControlVendas <span class="premium-badge">PREMIUM</span>
            </div>
            
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-info">
                    <span>Revendedora</span>
                    <img src="https://via.placeholder.com/35/10b981/ffffff?text=RV" alt="User Avatar">
                </div>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        
        <nav class="nav" id="main-nav">
            <a class="nav-item active" onclick="abrirTab('dashboard')">
                <i class="fas fa-chart-line"></i> <span>Dashboard</span>
            </a>
            <a class="nav-item" onclick="abrirTab('servicos')">
                <i class="fas fa-box-open"></i> <span>Vendas/Pedidos</span>
            </a>
            <a class="nav-item" onclick="abrirTab('estoque')">
                <i class="fas fa-warehouse"></i> <span>Estoque</span>
            </a>
            <a class="nav-item" onclick="abrirTab('clientes')">
                <i class="fas fa-users"></i> <span>Clientes</span>
            </a>
            <a class="nav-item" onclick="abrirTab('relatorios')">
                <i class="fas fa-file-invoice-dollar"></i> <span>Relatórios</span>
            </a>
            <a class="nav-item" onclick="abrirTab('configuracoes')">
                <i class="fas fa-cog"></i> <span>Configurações</span>
            </a>
            <a class="nav-item" onclick="limparTudo()" style="color: var(--danger);">
                <i class="fas fa-power-off"></i> <span>Limpar Dados</span>
            </a>
        </nav>
    </header>

    <main class="main-content">
        <div id="dashboard" class="tab-content active">
            <h2 class="section-title"><i class="fas fa-chart-line"></i> Visão Geral das Vendas</h2>

            <div class="dashboard-grid">
                <div class="dashboard-card receita">
                    <h3>Receita Bruta Total</h3>
                    <p class="value" id="totalReceita">R$ 0,00</p>
                    <div class="progress-bar">
                        <div class="progress-fill receita" id="progressReceita" style="width: 0%"></div>
                    </div>
                    <p style="font-size: 0.8rem; margin-top: 5px;" id="metaReceitaText">Meta: R$ 0,00</p>
                </div>
                <div class="dashboard-card custo">
                    <h3>Custo Total (Produtos + Entrega)</h3>
                    <p class="value" id="totalCusto">R$ 0,00</p>
                </div>
                <div class="dashboard-card lucro">
                    <h3>Lucro Líquido</h3>
                    <p class="value" id="totalLucro">R$ 0,00</p>
                </div>
                <div class="dashboard-card vendas">
                    <h3>Total de Vendas Registradas</h3>
                    <p class="value" id="totalServicos">0</p>
                </div>
                <div class="dashboard-card meta">
                    <h3>Meta Mensal</h3>
                    <p class="value" id="metaMensal">R$ 0,00</p>
                    <div class="progress-bar">
                        <div class="progress-fill meta" id="progressMeta" style="width: 0%"></div>
                    </div>
                    <p style="font-size: 0.8rem; margin-top: 5px;" id="atingimentoMeta">0% da meta</p>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h2>Receita e Lucro por Mês</h2>
                    <canvas id="receitaLucroChart"></canvas>
                </div>
                <div class="chart-card">
                    <h2>Status dos Pagamentos</h2>
                    <canvas id="statusPagamentoChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-bell"></i> Lembretes e Alertas</h2>
                <div id="lista-lembretes">
                    <!-- Lembretes serão carregados aqui -->
                </div>
            </div>
        </div>

        <div id="servicos" class="tab-content">
            <h2 class="section-title"><i class="fas fa-list-alt"></i> Registro e Controle de Pedidos</h2>

            <div class="card">
                <h2 id="servicoFormTitle"><i class="fas fa-plus-circle"></i> Nova Venda/Pedido</h2>
                
                <div class="form-grid grid-3-cols">
                    <div class="form-group full-width">
                        <label for="descricaoServico">Descrição da Venda (Produtos) *</label>
                        <input type="text" id="descricaoServico" placeholder="Ex: Perfume A, Brinco X e Colar Y" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="clienteServico">Cliente *</label>
                        <input type="text" id="clienteServico" placeholder="Nome da Amiga/Conhecida" required list="clientes-lista">
                        <datalist id="clientes-lista">
                            <!-- Opções de clientes serão preenchidas automaticamente -->
                        </datalist>
                    </div>
                    
                    <div class="form-group">
                        <label for="telefoneCliente">Telefone</label>
                        <input type="tel" id="telefoneCliente" placeholder="(11) 99999-9999">
                    </div>

                    <div class="form-group">
                        <label for="dataInicio">Data da Venda *</label>
                        <input type="date" id="dataInicio" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="dataFim">Data da Entrega (Opcional)</label>
                        <input type="date" id="dataFim">
                    </div>
                    
                    <div class="form-group">
                        <label for="valorServico">Valor Total da Venda (R$) *</label>
                        <input type="number" id="valorServico" step="0.01" min="0" placeholder="500.00" required oninput="atualizarPreview()">
                    </div>
                    
                    <div class="form-group">
                        <label for="custoMateriais">Custo dos Produtos/Estoque (R$) *</label>
                        <input type="number" id="custoMateriais" step="0.01" min="0" placeholder="200.00" required oninput="atualizarPreview()">
                    </div>
                    
                    <div class="form-group">
                        <label for="custoCombustivel">Custo de Entrega/Envio (R$) *</label>
                        <input type="number" id="custoCombustivel" step="0.01" min="0" placeholder="0.00" required oninput="atualizarPreview()">
                    </div>

                    <div class="form-group">
                        <label for="statusServico">Status do Pedido *</label>
                        <select id="statusServico" required>
                            <option value="em-andamento">Aguardando Pagamento/Envio</option>
                            <option value="finalizado">Venda Concluída/Entregue</option>
                            <option value="cancelado">Cancelado/Devolvido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="statusPagamento">Status Pagamento *</label>
                        <select id="statusPagamento" required>
                            <option value="pendente">Pendente (Falta Pagar)</option>
                            <option value="parcial">Parcial (Paga a metade, por exemplo)</option>
                            <option value="pago">Pago (Total)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="formaPagamento">Forma de Pagamento</label>
                        <select id="formaPagamento">
                            <option value="">Selecione...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="cartao-debito">Cartão Débito</option>
                            <option value="cartao-credito">Cartão Crédito</option>
                            <option value="transferencia">Transferência</option>
                            <option value="boleto">Boleto</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="observacaoServico">Observações</label>
                        <textarea id="observacaoServico" placeholder="Endereço de entrega, número de rastreio, detalhes dos produtos..." rows="3"></textarea>
                    </div>
                    
                    <input type="hidden" id="servicoIdEdicao">
                </div>

                <div id="previewServico" style="background: var(--bg-color); padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                    <h4><i class="fas fa-calculator"></i> Resumo da Venda</h4>
                    <div id="detalhesPreview"></div>
                </div>

                <div class="action-buttons">
                    <button id="btnCadastrarServico" onclick="adicionarServico()" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> Cadastrar Venda
                    </button>
                    <button id="btnSalvarEdicao" onclick="salvarEdicaoServico()" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-save"></i> Salvar Edição
                    </button>
                    <button id="btnCancelarEdicao" onclick="limparFormularioServico(true)" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-times-circle"></i> Cancelar Edição
                    </button>
                    <button onclick="limparFormularioServico()" class="btn btn-secondary">
                        <i class="fas fa-broom"></i> Limpar
                    </button>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-search"></i> Vendas Cadastradas</h2>
                
                <div class="filtros-container">
                    <div class="filtro-item">
                        <label for="filtroStatus">Status</label>
                        <select id="filtroStatus" onchange="filtrarTabela()">
                            <option value="">Todos</option>
                            <option value="em-andamento">Em Andamento</option>
                            <option value="finalizado">Finalizado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label for="filtroPagamento">Pagamento</label>
                        <select id="filtroPagamento" onchange="filtrarTabela()">
                            <option value="">Todos</option>
                            <option value="pendente">Pendente</option>
                            <option value="parcial">Parcial</option>
                            <option value="pago">Pago</option>
                        </select>
                    </div>
                    <div class="filtro-item">
                        <label for="filtroDataInicio">Data Início</label>
                        <input type="date" id="filtroDataInicio" onchange="filtrarTabela()">
                    </div>
                    <div class="filtro-item">
                        <label for="filtroDataFim">Data Fim</label>
                        <input type="date" id="filtroDataFim" onchange="filtrarTabela()">
                    </div>
                    <div class="filtro-item">
                        <label for="filtroCliente">Cliente</label>
                        <input type="text" id="filtroCliente" placeholder="Filtrar por cliente" oninput="filtrarTabela()">
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="tabela-servicos">
                        <thead>
                            <tr>
                                <th># ID</th>
                                <th>Data Venda</th>
                                <th>Cliente</th>
                                <th>Descrição Venda</th>
                                <th>Valor Total</th>
                                <th>Custo Produtos</th>
                                <th>Custo Entrega</th>
                                <th>Lucro</th>
                                <th>Status Pedido</th>
                                <th>Status Pag.</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaServicos">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="estoque" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-warehouse"></i> Gestão de Estoque</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="abrirModalEstoque()">
                        <i class="fas fa-plus"></i> Adicionar Produto
                    </button>
                    <button class="btn btn-info" onclick="gerarRelatorioEstoque()">
                        <i class="fas fa-file-pdf"></i> Relatório de Estoque
                    </button>
                </div>

                <div class="estoque-grid" id="lista-estoque">
                    <!-- Cards de estoque serão carregados aqui -->
                </div>
            </div>
        </div>

        <div id="clientes" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-users"></i> Clientes (Baseado em Vendas)</h2>
                <div class="table-responsive">
                    <table class="tabela-servicos">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Telefone</th>
                                <th>Total de Vendas</th>
                                <th>Valor Total Comprado</th>
                                <th>Última Compra</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="listaClientes">
                            </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: var(--text-muted);"><i class="fas fa-info-circle"></i> Esta lista é gerada automaticamente com base nos clientes cadastrados nas suas vendas.</p>
            </div>
        </div>

        <div id="relatorios" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-file-pdf"></i> Relatórios Financeiros</h2>
                
                <div class="tabs-internal">
                    <div class="tab-internal active" onclick="abrirRelatorioTab('financeiro')">Financeiro</div>
                    <div class="tab-internal" onclick="abrirRelatorioTab('vendas')">Vendas</div>
                    <div class="tab-internal" onclick="abrirRelatorioTab('clientes')">Clientes</div>
                    <div class="tab-internal" onclick="abrirRelatorioTab('estoque')">Estoque</div>
                </div>
                
                <div id="relatorio-financeiro" class="relatorio-tab">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="dataInicioRelatorio">Data Inicial</label>
                            <input type="date" id="dataInicioRelatorio">
                        </div>
                        <div class="form-group">
                            <label for="dataFimRelatorio">Data Final</label>
                            <input type="date" id="dataFimRelatorio">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="gerarRelatorioPDF()" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Gerar Relatório PDF</button>
                        <button onclick="gerarRelatorioExcel()" class="btn btn-success"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
                    </div>
                </div>
                
                <div id="relatorio-vendas" class="relatorio-tab" style="display: none;">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="dataInicioRelatorioVendas">Data Inicial</label>
                            <input type="date" id="dataInicioRelatorioVendas">
                        </div>
                        <div class="form-group">
                            <label for="dataFimRelatorioVendas">Data Final</label>
                            <input type="date" id="dataFimRelatorioVendas">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button onclick="gerarRelatorioVendasPDF()" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Relatório de Vendas PDF</button>
                    </div>
                </div>
                
                <div id="relatorio-clientes" class="relatorio-tab" style="display: none;">
                    <div class="action-buttons">
                        <button onclick="gerarRelatorioClientesPDF()" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Relatório de Clientes PDF</button>
                    </div>
                </div>
                
                <div id="relatorio-estoque" class="relatorio-tab" style="display: none;">
                    <div class="action-buttons">
                        <button onclick="gerarRelatorioEstoquePDF()" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Relatório de Estoque PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="configuracoes" class="tab-content">
            <div class="card">
                <h2><i class="fas fa-cog"></i> Configurações do Sistema</h2>
                
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="metaMensalInput">Meta de Vendas Mensal (R$)</label>
                        <input type="number" id="metaMensalInput" step="0.01" min="0" placeholder="5000.00">
                    </div>
                    <div class="form-group">
                        <label for="comissaoPercentual">Comissão (%)</label>
                        <input type="number" id="comissaoPercentual" step="0.01" min="0" max="100" placeholder="10">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button onclick="salvarConfiguracoes()" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar Configurações
                    </button>
                </div>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-database"></i> Backup e Restauração</h2>
                
                <div class="action-buttons">
                    <button onclick="exportarDados()" class="btn btn-info">
                        <i class="fas fa-download"></i> Exportar Dados
                    </button>
                    <button onclick="importarDados()" class="btn btn-warning">
                        <i class="fas fa-upload"></i> Importar Dados
                    </button>
                    <button onclick="criarBackupAutomatico()" class="btn btn-primary">
                        <i class="fas fa-sync"></i> Backup Automático
                    </button>
                </div>
                
                <div id="backup-status" style="margin-top: 15px; padding: 10px; background: var(--bg-color); border-radius: 6px;">
                    <p><i class="fas fa-info-circle"></i> Último backup: <span id="ultimoBackup">Nunca</span></p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Modal para Estoque -->
    <div class="modal" id="modalEstoque">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-box"></i> Gerenciar Produto</h2>
                <button class="modal-close" onclick="fecharModalEstoque()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label for="produtoNome">Nome do Produto *</label>
                        <input type="text" id="produtoNome" required>
                    </div>
                    <div class="form-group">
                        <label for="produtoCategoria">Categoria</label>
                        <select id="produtoCategoria">
                            <option value="perfume">Perfume</option>
                            <option value="joia">Joia</option>
                            <option value="acessorio">Acessório</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="produtoQuantidade">Quantidade em Estoque *</label>
                        <input type="number" id="produtoQuantidade" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="produtoQuantidadeMinima">Quantidade Mínima</label>
                        <input type="number" id="produtoQuantidadeMinima" min="0" value="5">
                    </div>
                    <div class="form-group">
                        <label for="produtoCusto">Custo Unitário (R$)</label>
                        <input type="number" id="produtoCusto" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="produtoPreco">Preço de Venda (R$)</label>
                        <input type="number" id="produtoPreco" step="0.01" min="0">
                    </div>
                    <div class="form-group full-width">
                        <label for="produtoDescricao">Descrição</label>
                        <textarea id="produtoDescricao" rows="3"></textarea>
                    </div>
                </div>
                <input type="hidden" id="produtoId">
            </div>
            <div class="modal-footer">
                <button onclick="fecharModalEstoque()" class="btn btn-secondary">Cancelar</button>
                <button onclick="salvarProduto()" class="btn btn-primary">Salvar Produto</button>
            </div>
        </div>
    </div>
    
    <div id="notification-area"></div>

    <script>
        // ========================================
        // VARIÁVEIS GLOBAIS E CONFIGURAÇÕES
        // ========================================
        
        let servicos = [];
        let estoque = [];
        let configuracoes = {
            metaMensal: 5000,
            comissaoPercentual: 10,
            tema: 'light',
            backupAutomatico: true
        };
        
        let receitaLucroChartInstance = null;
        let statusPagamentoChartInstance = null;

        // ========================================
        // FUNÇÕES DE NAVEGAÇÃO MOBILE
        // ========================================

        function toggleMobileMenu() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
        }

        function abrirTab(tabName) {
            // Fechar menu mobile se estiver aberto
            document.getElementById('main-nav').classList.remove('active');
            
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.nav-item[onclick="abrirTab('${tabName}')"]`).classList.add('active');
            
            // Ações específicas ao abrir cada tab
            if (tabName === 'servicos') {
                document.getElementById('dataInicio').value = obterDataHojeISO();
                montarTabelaServicos();
            } else if (tabName === 'dashboard') {
                atualizarDashboard();
            } else if (tabName === 'clientes') {
                montarTabelaClientes();
            } else if (tabName === 'estoque') {
                atualizarEstoque();
            } else if (tabName === 'configuracoes') {
                carregarConfiguracoes();
            }
        }

        // ========================================
        // FUNÇÕES UTILITÁRIAS
        // ========================================

        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor);
        }

        function obterDataHojeISO() {
            return new Date().toISOString().split('T')[0];
        }

        function mostrarNotificacao(mensagem, tipo = 'info') {
            const area = document.getElementById('notification-area');
            const notif = document.createElement('div');
            notif.className = `notification ${tipo}`;
            
            const icones = {
                'sucesso': 'fa-check-circle',
                'erro': 'fa-exclamation-circle',
                'aviso': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            notif.innerHTML = `
                <i class="fas ${icones[tipo] || 'fa-info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            
            area.appendChild(notif);
            
            // Força o reflow para aplicar a transição
            void notif.offsetWidth; 
            notif.classList.add('show');

            setTimeout(() => {
                notif.classList.remove('show');
                setTimeout(() => {
                    area.removeChild(notif);
                }, 400);
            }, 3000);
        }

        function toggleTheme() {
            const body = document.body;
            const temaAtual = body.getAttribute('data-theme') || 'light';
            const novoTema = temaAtual === 'light' ? 'dark' : 'light';
            
            body.setAttribute('data-theme', novoTema);
            configuracoes.tema = novoTema;
            salvarConfiguracoes();
            
            const icon = document.querySelector('.theme-toggle i');
            icon.className = novoTema === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            mostrarNotificacao(`Tema ${novoTema === 'dark' ? 'escuro' : 'claro'} ativado`, 'sucesso');
        }

        // ========================================
        // PERSISTÊNCIA DE DADOS (LocalStorage)
        // ========================================

        function salvarDados() {
            localStorage.setItem('controlVendas_servicos', JSON.stringify(servicos));
            localStorage.setItem('controlVendas_estoque', JSON.stringify(estoque));
            localStorage.setItem('controlVendas_config', JSON.stringify(configuracoes));
        }

        function carregarDados() {
            const dadosSalvosServicos = localStorage.getItem('controlVendas_servicos');
            const dadosSalvosEstoque = localStorage.getItem('controlVendas_estoque');
            const dadosSalvosConfig = localStorage.getItem('controlVendas_config');
            
            if (dadosSalvosServicos) servicos = JSON.parse(dadosSalvosServicos);
            if (dadosSalvosEstoque) estoque = JSON.parse(dadosSalvosEstoque);
            if (dadosSalvosConfig) {
                configuracoes = { ...configuracoes, ...JSON.parse(dadosSalvosConfig) };
            }
        }

        function limparTudo() {
            if (confirm('ATENÇÃO: Você tem certeza que deseja APAGAR TODOS os dados? Esta ação é irreversível.')) {
                localStorage.removeItem('controlVendas_servicos');
                localStorage.removeItem('controlVendas_estoque');
                localStorage.removeItem('controlVendas_config');
                servicos = [];
                estoque = [];
                checkInitializers();
                mostrarNotificacao('Todos os dados foram limpos com sucesso!', 'sucesso');
            }
        }
        
        function criarDadosExemplo() {
            const servicosExemplo = [
                {
                    id: Date.now() - 1000,
                    descricao: "Venda de Kit Colar e Brincos + Perfume Amora",
                    cliente: "Amiga Joana",
                    telefone: "11988887777",
                    dataInicio: '2025-10-20',
                    dataFim: '2025-10-20',
                    valorServico: 180.00,
                    custoMateriais: 65.00,
                    custoCombustivel: 0.00,
                    status: "finalizado",
                    statusPagamento: "pago",
                    formaPagamento: "pix",
                    observacao: "Pagamento à vista via PIX. Entregue em mãos.",
                    dataCadastro: '2025-10-20'
                },
                {
                    id: Date.now() - 500,
                    descricao: "2 Perfumes Flor de Lis e Colcha de Cama",
                    cliente: "Vizinha Paula",
                    telefone: "11999990000",
                    dataInicio: '2025-11-05',
                    dataFim: '2025-11-07',
                    valorServico: 450.00,
                    custoMateriais: 180.00,
                    custoCombustivel: 15.00,
                    status: "em-andamento",
                    statusPagamento: "parcial",
                    formaPagamento: "cartao-credito",
                    observacao: "Parcelado em 3x no cartão. Falta receber a última parcela.",
                    dataCadastro: '2025-11-05'
                },
                {
                    id: Date.now() - 100,
                    descricao: "Anel Solitário e Perfume Masculino",
                    cliente: "Prima Maria",
                    telefone: "11987654321",
                    dataInicio: '2025-11-18',
                    dataFim: '',
                    valorServico: 300.00,
                    custoMateriais: 110.00,
                    custoCombustivel: 0.00,
                    status: "em-andamento",
                    statusPagamento: "pendente",
                    formaPagamento: "dinheiro",
                    observacao: "Ficou de pagar na próxima semana (fiado).",
                    dataCadastro: '2025-11-18'
                }
            ];

            const estoqueExemplo = [
                {
                    id: Date.now() - 2000,
                    nome: "Perfume Flor de Lis",
                    categoria: "perfume",
                    quantidade: 15,
                    quantidadeMinima: 5,
                    custo: 25.00,
                    preco: 80.00,
                    descricao: "Perfume feminino floral"
                },
                {
                    id: Date.now() - 1500,
                    nome: "Brinco Pérola",
                    categoria: "joia",
                    quantidade: 8,
                    quantidadeMinima: 3,
                    custo: 15.00,
                    preco: 45.00,
                    descricao: "Brinco de pérola natural"
                },
                {
                    id: Date.now() - 1000,
                    nome: "Colar Prata",
                    categoria: "joia",
                    quantidade: 2,
                    quantidadeMinima: 5,
                    custo: 30.00,
                    preco: 90.00,
                    descricao: "Colar de prata 925"
                }
            ];

            servicos = servicosExemplo;
            estoque = estoqueExemplo;
            salvarDados();
            checkInitializers();
            mostrarNotificacao('Dados de exemplo criados com sucesso!', 'sucesso');
        }

        // ========================================
        // CÁLCULOS E DASHBOARD
        // ========================================
        
        function calcularLucro(valor, custoM, custoC) {
            return valor - custoM - custoC;
        }

        function atualizarPreview() {
            const valorServico = parseFloat(document.getElementById('valorServico').value) || 0;
            const custoMateriais = parseFloat(document.getElementById('custoMateriais').value) || 0;
            const custoCombustivel = parseFloat(document.getElementById('custoCombustivel').value) || 0;
            const lucro = calcularLucro(valorServico, custoMateriais, custoCombustivel);
            
            const detalhes = document.getElementById('detalhesPreview');
            const previewDiv = document.getElementById('previewServico');

            if (valorServico > 0) {
                previewDiv.style.display = 'block';
                detalhes.innerHTML = `
                    <p><strong>Valor Venda:</strong> ${formatarMoeda(valorServico)}</p>
                    <p><strong>Custo Total:</strong> ${formatarMoeda(custoMateriais + custoCombustivel)}</p>
                    <p><strong>Lucro Estimado:</strong> <span style="font-weight: bold; color: ${lucro >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatarMoeda(lucro)}</span></p>
                `;
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function atualizarDashboard() {
            const totalReceita = servicos.reduce((acc, s) => acc + s.valorServico, 0);
            const totalCusto = servicos.reduce((acc, s) => acc + s.custoMateriais + s.custoCombustivel, 0);
            const totalLucro = servicos.reduce((acc, s) => acc + calcularLucro(s.valorServico, s.custoMateriais, s.custoCombustivel), 0);
            const totalServicos = servicos.length;

            // Atualizar valores
            document.getElementById('totalReceita').textContent = formatarMoeda(totalReceita);
            document.getElementById('totalCusto').textContent = formatarMoeda(totalCusto);
            document.getElementById('totalLucro').textContent = formatarMoeda(totalLucro);
            document.getElementById('totalServicos').textContent = totalServicos;
            document.getElementById('metaMensal').textContent = formatarMoeda(configuracoes.metaMensal);

            // Atualizar barras de progresso
            const progressoReceita = Math.min((totalReceita / (configuracoes.metaMensal * 3)) * 100, 100);
            const progressoMeta = Math.min((totalReceita / configuracoes.metaMensal) * 100, 100);
            
            document.getElementById('progressReceita').style.width = `${progressoReceita}%`;
            document.getElementById('progressMeta').style.width = `${progressoMeta}%`;
            
            document.getElementById('metaReceitaText').textContent = `Meta: ${formatarMoeda(configuracoes.metaMensal * 3)}`;
            document.getElementById('atingimentoMeta').textContent = `${progressoMeta.toFixed(1)}% da meta`;
            
            montarTabelaServicos();
            montarTabelaClientes();
            atualizarLembretes();
            atualizarEstoque();
            renderizarCharts();
        }

        // ========================================
        // GESTÃO DE VENDAS/PEDIDOS
        // ========================================

        function montarTabelaServicos() {
            const tbody = document.getElementById('listaServicos');
            tbody.innerHTML = '';

            servicos.sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio));

            if (servicos.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" style="text-align: center;">Nenhuma venda registrada. <a href="#" onclick="criarDadosExemplo()" style="color: var(--primary);">Clique aqui para criar dados de exemplo.</a></td></tr>`;
                return;
            }

            servicos.forEach(servico => {
                const lucro = calcularLucro(servico.valorServico, servico.custoMateriais, servico.custoCombustivel);
                const lucroFormatado = `<span style="color: ${lucro >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${formatarMoeda(lucro)}</span>`;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${servico.id}</td>
                    <td>${new Date(servico.dataInicio).toLocaleDateString('pt-BR')}</td>
                    <td>${servico.cliente}</td>
                    <td title="${servico.descricao}">${servico.descricao.substring(0, 30)}...</td>
                    <td>${formatarMoeda(servico.valorServico)}</td>
                    <td>${formatarMoeda(servico.custoMateriais)}</td>
                    <td>${formatarMoeda(servico.custoCombustivel)}</td>
                    <td>${lucroFormatado}</td>
                    <td><span class="status-badge ${servico.status}">${servico.status.replace('-', ' ')}</span></td>
                    <td><span class="status-badge ${servico.statusPagamento}">${servico.statusPagamento.replace('-', ' ')}</span></td>
                    <td class="table-actions">
                        <button onclick="editarServico(${servico.id})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button onclick="excluirServico(${servico.id})" class="delete" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            });
            
            // Atualizar lista de clientes para autocomplete
            atualizarListaClientes();
        }
        
        function filtrarTabela() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroPagamento = document.getElementById('filtroPagamento').value;
            const filtroDataInicio = document.getElementById('filtroDataInicio').value;
            const filtroDataFim = document.getElementById('filtroDataFim').value;
            const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase();
            
            const linhas = document.querySelectorAll('#listaServicos tr');
            
            linhas.forEach(linha => {
                if (linha.cells.length < 2) return; // Pular linha vazia
                
                const status = linha.cells[8].querySelector('.status-badge').className.includes(filtroStatus) || !filtroStatus;
                const pagamento = linha.cells[9].querySelector('.status-badge').className.includes(filtroPagamento) || !filtroPagamento;
                const data = linha.cells[1].textContent;
                const cliente = linha.cells[2].textContent.toLowerCase().includes(filtroCliente) || !filtroCliente;
                
                const dataFiltro = (!filtroDataInicio || new Date(data.split('/').reverse().join('-')) >= new Date(filtroDataInicio)) &&
                                  (!filtroDataFim || new Date(data.split('/').reverse().join('-')) <= new Date(filtroDataFim));
                
                if (status && pagamento && dataFiltro && cliente) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }
        
        function limparFormularioServico(cancelandoEdicao = false) {
            document.getElementById('servicoIdEdicao').value = '';
            document.getElementById('descricaoServico').value = '';
            document.getElementById('clienteServico').value = '';
            document.getElementById('telefoneCliente').value = '';
            
            document.getElementById('dataInicio').value = obterDataHojeISO();
            document.getElementById('dataFim').value = '';
            
            document.getElementById('valorServico').value = '';
            document.getElementById('custoMateriais').value = '';
            document.getElementById('custoCombustivel').value = '';
            document.getElementById('statusServico').value = 'em-andamento';
            document.getElementById('statusPagamento').value = 'pendente';
            document.getElementById('formaPagamento').value = '';
            document.getElementById('observacaoServico').value = '';
            
            // Reverter botões e título para o modo de cadastro
            document.getElementById('servicoFormTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Nova Venda/Pedido';
            document.getElementById('btnCadastrarServico').style.display = 'inline-block';
            document.getElementById('btnSalvarEdicao').style.display = 'none';
            document.getElementById('btnCancelarEdicao').style.display = 'none';
            document.getElementById('previewServico').style.display = 'none';
            
            if (cancelandoEdicao) {
                mostrarNotificacao('Edição cancelada.', 'aviso');
            }
        }

        function adicionarServico() {
            const descricao = document.getElementById('descricaoServico').value.trim();
            const cliente = document.getElementById('clienteServico').value.trim();
            const telefone = document.getElementById('telefoneCliente').value.trim();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const valorServico = parseFloat(document.getElementById('valorServico').value) || 0;
            const custoMateriais = parseFloat(document.getElementById('custoMateriais').value) || 0;
            const custoCombustivel = parseFloat(document.getElementById('custoCombustivel').value) || 0;
            const status = document.getElementById('statusServico').value;
            const statusPagamento = document.getElementById('statusPagamento').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const observacao = document.getElementById('observacaoServico').value.trim();

            if (!descricao || !cliente || !dataInicio || valorServico <= 0) {
                mostrarNotificacao('Descrição, Cliente, Data Venda e Valor Total são obrigatórios.', 'erro');
                return;
            }

            const novoServico = {
                id: Date.now(),
                descricao,
                cliente,
                telefone,
                dataInicio,
                dataFim,
                valorServico,
                custoMateriais,
                custoCombustivel,
                status,
                statusPagamento,
                formaPagamento,
                observacao,
                dataCadastro: obterDataHojeISO()
            };

            servicos.push(novoServico);
            salvarDados();
            atualizarDashboard();
            limparFormularioServico();
            mostrarNotificacao('Venda cadastrada com sucesso!', 'sucesso');
        }

        function editarServico(id) {
            const servico = servicos.find(s => s.id === id);
            if (!servico) return;

            // Preenche o formulário
            document.getElementById('servicoIdEdicao').value = servico.id;
            document.getElementById('descricaoServico').value = servico.descricao;
            document.getElementById('clienteServico').value = servico.cliente;
            document.getElementById('telefoneCliente').value = servico.telefone;
            
            document.getElementById('dataInicio').value = servico.dataInicio;
            document.getElementById('dataFim').value = servico.dataFim;
            
            document.getElementById('valorServico').value = servico.valorServico;
            document.getElementById('custoMateriais').value = servico.custoMateriais;
            document.getElementById('custoCombustivel').value = servico.custoCombustivel;
            document.getElementById('statusServico').value = servico.status;
            document.getElementById('statusPagamento').value = servico.statusPagamento;
            document.getElementById('formaPagamento').value = servico.formaPagamento;
            document.getElementById('observacaoServico').value = servico.observacao;

            atualizarPreview();

            // Altera botões e título para o modo de edição
            document.getElementById('servicoFormTitle').innerHTML = `<i class="fas fa-edit"></i> Editar Venda (ID: ${servico.id})`;
            document.getElementById('btnCadastrarServico').style.display = 'none';
            document.getElementById('btnSalvarEdicao').style.display = 'inline-block';
            document.getElementById('btnCancelarEdicao').style.display = 'inline-block';
            
            // Rola para o formulário
            document.getElementById('servicos').scrollIntoView({ behavior: 'smooth' });
        }

        function salvarEdicaoServico() {
            const id = parseInt(document.getElementById('servicoIdEdicao').value);
            const index = servicos.findIndex(s => s.id === id);

            if (index === -1) {
                mostrarNotificacao('Erro: Venda não encontrada para edição.', 'erro');
                return;
            }

            // Captura os novos dados do formulário
            const descricao = document.getElementById('descricaoServico').value.trim();
            const cliente = document.getElementById('clienteServico').value.trim();
            const telefone = document.getElementById('telefoneCliente').value.trim();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const valorServico = parseFloat(document.getElementById('valorServico').value) || 0;
            const custoMateriais = parseFloat(document.getElementById('custoMateriais').value) || 0;
            const custoCombustivel = parseFloat(document.getElementById('custoCombustivel').value) || 0;
            const status = document.getElementById('statusServico').value;
            const statusPagamento = document.getElementById('statusPagamento').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const observacao = document.getElementById('observacaoServico').value.trim();

            if (!descricao || !cliente || !dataInicio || valorServico <= 0) {
                mostrarNotificacao('Descrição, Cliente, Data Venda e Valor Total são obrigatórios.', 'erro');
                return;
            }

            // Atualiza o objeto
            servicos[index] = {
                ...servicos[index],
                descricao,
                cliente,
                telefone,
                dataInicio,
                dataFim,
                valorServico,
                custoMateriais,
                custoCombustivel,
                status,
                statusPagamento,
                formaPagamento,
                observacao
            };

            salvarDados();
            atualizarDashboard();
            limparFormularioServico();
            mostrarNotificacao('Venda editada com sucesso!', 'sucesso');
        }

        function excluirServico(id) {
            if (confirm(`Tem certeza que deseja excluir a venda com ID ${id}?`)) {
                servicos = servicos.filter(s => s.id !== id);
                salvarDados();
                atualizarDashboard();
                mostrarNotificacao('Venda excluída com sucesso!', 'sucesso');
            }
        }

        // ========================================
        // GESTÃO DE CLIENTES
        // ========================================

        function montarTabelaClientes() {
            const tbody = document.getElementById('listaClientes');
            tbody.innerHTML = '';

            const clientesMap = {};

            // Agrupa dados por cliente
            servicos.forEach(venda => {
                const nome = venda.cliente.trim();
                if (!clientesMap[nome]) {
                    clientesMap[nome] = {
                        telefone: venda.telefone,
                        totalVendas: 0,
                        valorTotalComprado: 0,
                        ultimaCompra: venda.dataInicio
                    };
                }
                clientesMap[nome].totalVendas += 1;
                clientesMap[nome].valorTotalComprado += venda.valorServico;
                
                // Atualiza a última compra se for mais recente
                if (new Date(venda.dataInicio) > new Date(clientesMap[nome].ultimaCompra)) {
                    clientesMap[nome].ultimaCompra = venda.dataInicio;
                }
            });

            const clientesLista = Object.keys(clientesMap).map(nome => ({
                nome,
                ...clientesMap[nome]
            }));

            // Ordena por valor total comprado
            clientesLista.sort((a, b) => b.valorTotalComprado - a.valorTotalComprado);

            if (clientesLista.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align: center;">Nenhum cliente com vendas registradas.</td></tr>`;
                return;
            }

            clientesLista.forEach(cliente => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cliente.nome}</td>
                    <td>${cliente.telefone || 'N/A'}</td>
                    <td>${cliente.totalVendas}</td>
                    <td>${formatarMoeda(cliente.valorTotalComprado)}</td>
                    <td>${new Date(cliente.ultimaCompra).toLocaleDateString('pt-BR')}</td>
                    <td class="table-actions">
                        <button onclick="verDetalhesCliente('${cliente.nome}')" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                    </td>
                `;
            });
        }
        
        function atualizarListaClientes() {
            const datalist = document.getElementById('clientes-lista');
            datalist.innerHTML = '';
            
            const clientesUnicos = [...new Set(servicos.map(s => s.cliente))];
            
            clientesUnicos.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                datalist.appendChild(option);
            });
        }
        
        function verDetalhesCliente(nome) {
            const vendasCliente = servicos.filter(s => s.cliente === nome);
            let detalhes = `
                <h3>Histórico de Compras - ${nome}</h3>
                <p><strong>Total de Vendas:</strong> ${vendasCliente.length}</p>
                <p><strong>Valor Total Gasto:</strong> ${formatarMoeda(vendasCliente.reduce((acc, v) => acc + v.valorServico, 0))}</p>
                <hr>
                <h4>Últimas Vendas:</h4>
                <ul>
            `;
            
            vendasCliente
                .sort((a, b) => new Date(b.dataInicio) - new Date(a.dataInicio))
                .slice(0, 5)
                .forEach(venda => {
                    detalhes += `
                        <li>
                            ${new Date(venda.dataInicio).toLocaleDateString('pt-BR')} - 
                            ${venda.descricao.substring(0, 30)}... - 
                            ${formatarMoeda(venda.valorServico)} - 
                            <span class="status-badge ${venda.statusPagamento}">${venda.statusPagamento}</span>
                        </li>
                    `;
                });
            
            detalhes += '</ul>';
            
            mostrarNotificacao(detalhes, 'info');
        }

        // ========================================
        // GESTÃO DE ESTOQUE
        // ========================================

        function atualizarEstoque() {
            const container = document.getElementById('lista-estoque');
            container.innerHTML = '';
            
            if (estoque.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 10px;"></i>
                        <p>Nenhum produto cadastrado no estoque.</p>
                        <button class="btn btn-primary" onclick="abrirModalEstoque()">
                            <i class="fas fa-plus"></i> Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }
            
            estoque.forEach(produto => {
                const card = document.createElement('div');
                card.className = `estoque-card ${produto.quantidade <= produto.quantidadeMinima ? 'baixo' : ''}`;
                
                card.innerHTML = `
                    <h3>${produto.nome}</h3>
                    <p class="quantidade">${produto.quantidade} unidades</p>
                    <p><strong>Categoria:</strong> ${produto.categoria}</p>
                    <p><strong>Custo:</strong> ${formatarMoeda(produto.custo)}</p>
                    <p><strong>Preço:</strong> ${formatarMoeda(produto.preco)}</p>
                    ${produto.quantidade <= produto.quantidadeMinima ? 
                        `<p class="alerta"><i class="fas fa-exclamation-triangle"></i> Estoque baixo!</p>` : ''}
                    <div class="action-buttons" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="editarProduto(${produto.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger" onclick="excluirProduto(${produto.id})" style="padding: 5px 10px; font-size: 0.8rem;">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        function abrirModalEstoque(produtoId = null) {
            const modal = document.getElementById('modalEstoque');
            modal.classList.add('active');
            
            if (produtoId) {
                // Modo edição
                const produto = estoque.find(p => p.id === produtoId);
                if (produto) {
                    document.getElementById('produtoId').value = produto.id;
                    document.getElementById('produtoNome').value = produto.nome;
                    document.getElementById('produtoCategoria').value = produto.categoria;
                    document.getElementById('produtoQuantidade').value = produto.quantidade;
                    document.getElementById('produtoQuantidadeMinima').value = produto.quantidadeMinima;
                    document.getElementById('produtoCusto').value = produto.custo;
                    document.getElementById('produtoPreco').value = produto.preco;
                    document.getElementById('produtoDescricao').value = produto.descricao || '';
                }
            } else {
                // Modo adição
                document.getElementById('produtoId').value = '';
                document.getElementById('produtoNome').value = '';
                document.getElementById('produtoCategoria').value = 'perfume';
                document.getElementById('produtoQuantidade').value = '0';
                document.getElementById('produtoQuantidadeMinima').value = '5';
                document.getElementById('produtoCusto').value = '';
                document.getElementById('produtoPreco').value = '';
                document.getElementById('produtoDescricao').value = '';
            }
        }
        
        function fecharModalEstoque() {
            document.getElementById('modalEstoque').classList.remove('active');
        }
        
        function salvarProduto() {
            const id = document.getElementById('produtoId').value;
            const nome = document.getElementById('produtoNome').value.trim();
            const categoria = document.getElementById('produtoCategoria').value;
            const quantidade = parseInt(document.getElementById('produtoQuantidade').value) || 0;
            const quantidadeMinima = parseInt(document.getElementById('produtoQuantidadeMinima').value) || 0;
            const custo = parseFloat(document.getElementById('produtoCusto').value) || 0;
            const preco = parseFloat(document.getElementById('produtoPreco').value) || 0;
            const descricao = document.getElementById('produtoDescricao').value.trim();
            
            if (!nome) {
                mostrarNotificacao('Nome do produto é obrigatório.', 'erro');
                return;
            }
            
            if (id) {
                // Editar produto existente
                const index = estoque.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    estoque[index] = {
                        ...estoque[index],
                        nome,
                        categoria,
                        quantidade,
                        quantidadeMinima,
                        custo,
                        preco,
                        descricao
                    };
                }
            } else {
                // Adicionar novo produto
                const novoProduto = {
                    id: Date.now(),
                    nome,
                    categoria,
                    quantidade,
                    quantidadeMinima,
                    custo,
                    preco,
                    descricao
                };
                estoque.push(novoProduto);
            }
            
            salvarDados();
            atualizarEstoque();
            fecharModalEstoque();
            mostrarNotificacao(`Produto ${id ? 'atualizado' : 'adicionado'} com sucesso!`, 'sucesso');
        }
        
        function editarProduto(id) {
            abrirModalEstoque(id);
        }
        
        function excluirProduto(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                estoque = estoque.filter(p => p.id !== id);
                salvarDados();
                atualizarEstoque();
                mostrarNotificacao('Produto excluído com sucesso!', 'sucesso');
            }
        }
        
        function gerarRelatorioEstoque() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            doc.setFontSize(18);
            doc.text('Relatório de Estoque - ControlVendas', 10, 10);
            
            doc.setFontSize(12);
            doc.text(`Data do Relatório: ${new Date().toLocaleDateString('pt-BR')}`, 10, 20);
            
            // Tabela de estoque
            const headers = [['Produto', 'Categoria', 'Quantidade', 'Mínimo', 'Custo', 'Preço']];
            
            const body = estoque.map(p => [
                p.nome,
                p.categoria,
                p.quantidade.toString(),
                p.quantidadeMinima.toString(),
                formatarMoeda(p.custo),
                formatarMoeda(p.preco)
            ]);
            
            doc.autoTable({
                startY: 30,
                head: headers,
                body: body,
                styles: { fontSize: 10, cellPadding: 3 },
                headStyles: { fillColor: [16, 185, 129] }
            });
            
            // Produtos com estoque baixo
            const estoqueBaixo = estoque.filter(p => p.quantidade <= p.quantidadeMinima);
            if (estoqueBaixo.length > 0) {
                doc.setFontSize(14);
                doc.text('Produtos com Estoque Baixo:', 10, doc.lastAutoTable.finalY + 10);
                
                const bodyAlerta = estoqueBaixo.map(p => [
                    p.nome,
                    p.quantidade.toString(),
                    p.quantidadeMinima.toString()
                ]);
                
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 15,
                    head: [['Produto', 'Quantidade', 'Mínimo']],
                    body: bodyAlerta,
                    styles: { fontSize: 10, cellPadding: 3 },
                    headStyles: { fillColor: [239, 68, 68] }
                });
            }
            
            doc.save('Relatorio_Estoque_ControlVendas.pdf');
            mostrarNotificacao('Relatório de estoque gerado com sucesso!', 'sucesso');
        }

        // ========================================
        // LEMBRETES E ALERTAS
        // ========================================

        function atualizarLembretes() {
            const container = document.getElementById('lista-lembretes');
            container.innerHTML = '';
            
            const lembretes = [];
            
            // Verificar pagamentos pendentes
            const pagamentosPendentes = servicos.filter(s => s.statusPagamento === 'pendente' || s.statusPagamento === 'parcial');
            if (pagamentosPendentes.length > 0) {
                lembretes.push({
                    tipo: 'pagamento',
                    titulo: 'Pagamentos Pendentes',
                    descricao: `Você tem ${pagamentosPendentes.length} venda(s) com pagamento pendente.`,
                    prioridade: 'alta'
                });
            }
            
            // Verificar estoque baixo
            const estoqueBaixo = estoque.filter(p => p.quantidade <= p.quantidadeMinima);
            if (estoqueBaixo.length > 0) {
                lembretes.push({
                    tipo: 'estoque',
                    titulo: 'Estoque Baixo',
                    descricao: `${estoqueBaixo.length} produto(s) com estoque baixo.`,
                    prioridade: 'media'
                });
            }
            
            // Verificar meta mensal
            const receitaAtual = servicos.reduce((acc, s) => acc + s.valorServico, 0);
            const percentualMeta = (receitaAtual / configuracoes.metaMensal) * 100;
            
            if (percentualMeta < 50) {
                lembretes.push({
                    tipo: 'meta',
                    titulo: 'Meta Mensal',
                    descricao: `Você atingiu ${percentualMeta.toFixed(1)}% da sua meta mensal.`,
                    prioridade: 'baixa'
                });
            }
            
            if (lembretes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Nenhum lembrete ou alerta no momento.</p>
                    </div>
                `;
                return;
            }
            
            lembretes.forEach(lembrete => {
                const item = document.createElement('div');
                item.className = 'lembrete-item';
                
                const icones = {
                    'pagamento': 'fa-money-bill-wave',
                    'estoque': 'fa-box',
                    'meta': 'fa-bullseye'
                };
                
                const cores = {
                    'alta': 'var(--danger)',
                    'media': 'var(--warning)',
                    'baixa': 'var(--info)'
                };
                
                item.style.borderLeftColor = cores[lembrete.prioridade];
                
                item.innerHTML = `
                    <div class="info">
                        <h4><i class="fas ${icones[lembrete.tipo]}"></i> ${lembrete.titulo}</h4>
                        <p>${lembrete.descricao}</p>
                    </div>
                    <div class="acoes">
                        <button class="btn btn-primary" onclick="verDetalhesLembrete('${lembrete.tipo}')" style="padding: 5px 10px;">
                            <i class="fas fa-eye"></i> Ver
                        </button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        function verDetalhesLembrete(tipo) {
            switch(tipo) {
                case 'pagamento':
                    document.getElementById('filtroPagamento').value = 'pendente';
                    filtrarTabela();
                    abrirTab('servicos');
                    break;
                case 'estoque':
                    abrirTab('estoque');
                    break;
                case 'meta':
                    abrirTab('configuracoes');
                    break;
            }
        }

        // ========================================
        // GRÁFICOS (CHARTS)
        // ========================================

        function renderizarCharts() {
            // 1. Receita e Lucro Mensal (Gráfico de Barras)
            const dadosMensais = servicos.reduce((acc, s) => {
                const mesAno = s.dataInicio.substring(0, 7);
                const lucro = calcularLucro(s.valorServico, s.custoMateriais, s.custoCombustivel);
                const receita = s.valorServico;
                
                if (!acc[mesAno]) {
                    acc[mesAno] = { receita: 0, lucro: 0 };
                }
                acc[mesAno].receita += receita;
                acc[mesAno].lucro += lucro;
                return acc;
            }, {});

            const labels = Object.keys(dadosMensais).sort();
            const receitas = labels.map(l => dadosMensais[l].receita);
            const lucros = labels.map(l => dadosMensais[l].lucro);

            if (receitaLucroChartInstance) {
                receitaLucroChartInstance.destroy();
            }

            const ctx1 = document.getElementById('receitaLucroChart').getContext('2d');
            receitaLucroChartInstance = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Receita Bruta (R$)',
                            data: receitas,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Lucro Líquido (R$)',
                            data: lucros,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Receita e Lucro por Mês'
                        }
                    }
                }
            });

            // 2. Status de Pagamento (Gráfico de Pizza)
            const dadosStatusPagamento = servicos.reduce((acc, s) => {
                acc[s.statusPagamento] = (acc[s.statusPagamento] || 0) + 1;
                return acc;
            }, {});

            if (statusPagamentoChartInstance) {
                statusPagamentoChartInstance.destroy();
            }

            const ctx2 = document.getElementById('statusPagamentoChart').getContext('2d');
            statusPagamentoChartInstance = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Parcial', 'Pago'],
                    datasets: [{
                        data: [
                            dadosStatusPagamento['pendente'] || 0,
                            dadosStatusPagamento['parcial'] || 0,
                            dadosStatusPagamento['pago'] || 0
                        ],
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(16, 185, 129, 0.8)'
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Controle de Pagamentos'
                        }
                    }
                }
            });
        }

        // ========================================
        // RELATÓRIOS PDF
        // ========================================

        function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Modo paisagem
            
            // Configurações de datas
            const dataInicioStr = document.getElementById('dataInicioRelatorio').value;
            const dataFimStr = document.getElementById('dataFimRelatorio').value;

            let vendasFiltradas = [...servicos];

            if (dataInicioStr) {
                const dataInicio = new Date(dataInicioStr);
                vendasFiltradas = vendasFiltradas.filter(v => new Date(v.dataInicio) >= dataInicio);
            }
            if (dataFimStr) {
                const dataFim = new Date(dataFimStr);
                vendasFiltradas = vendasFiltradas.filter(v => new Date(v.dataInicio) <= dataFim);
            }
            
            // Cabeçalho
            doc.setFillColor(16, 185, 129);
            doc.rect(0, 0, 297, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text('RELATÓRIO FINANCEIRO - CONTROL VENDAS', 148, 12, { align: 'center' });
            
            // Informações de Resumo
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            doc.text(`Período: ${dataInicioStr || 'Início'} a ${dataFimStr || 'Atual'}`, 20, 30);
            doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, 200, 30);
            
            const totalReceita = vendasFiltradas.reduce((acc, s) => acc + s.valorServico, 0);
            const totalCusto = vendasFiltradas.reduce((acc, s) => acc + s.custoMateriais + s.custoCombustivel, 0);
            const totalLucro = totalReceita - totalCusto;
            
            doc.setFontSize(12);
            doc.text(`Vendas Registradas: ${vendasFiltradas.length}`, 20, 45);
            doc.text(`Receita Bruta: ${formatarMoeda(totalReceita)}`, 20, 55);
            doc.text(`Custo Total: ${formatarMoeda(totalCusto)}`, 100, 55);
            doc.text(`Lucro Líquido: ${formatarMoeda(totalLucro)}`, 180, 55);
            
            // Tabela de Dados
            const headers = [
                ['ID', 'Data', 'Cliente', 'Descrição', 'Valor', 'Custo', 'Lucro', 'Pagamento']
            ];

            const body = vendasFiltradas.map(v => [
                v.id,
                new Date(v.dataInicio).toLocaleDateString('pt-BR'),
                v.cliente,
                v.descricao.substring(0, 25) + '...',
                formatarMoeda(v.valorServico),
                formatarMoeda(v.custoMateriais + v.custoCombustivel),
                formatarMoeda(calcularLucro(v.valorServico, v.custoMateriais, v.custoCombustivel)),
                v.statusPagamento.toUpperCase()
            ]);

            doc.autoTable({
                startY: 65,
                head: headers,
                body: body,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [16, 185, 129] },
                margin: { top: 65 }
            });
            
            // Rodapé
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('ControlVendas Premium - Sistema de Gestão Completa', 148, finalY, { align: 'center' });

            doc.save('Relatorio_Financeiro_ControlVendas.pdf');
            mostrarNotificacao('Relatório PDF gerado com sucesso!', 'sucesso');
        }
        
        function gerarRelatorioExcel() {
            // Simulação de exportação para Excel
            mostrarNotificacao('Funcionalidade de exportação para Excel em desenvolvimento.', 'info');
        }
        
        function abrirRelatorioTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.relatorio-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-internal').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(`relatorio-${tabName}`).style.display = 'block';
            
            // Adicionar classe active à aba selecionada
            document.querySelector(`.tab-internal[onclick="abrirRelatorioTab('${tabName}')"]`).classList.add('active');
        }

        // ========================================
        // CONFIGURAÇÕES E BACKUP
        // ========================================

        function salvarConfiguracoes() {
            const metaMensal = parseFloat(document.getElementById('metaMensalInput').value) || 0;
            const comissao = parseFloat(document.getElementById('comissaoPercentual').value) || 0;
            
            configuracoes.metaMensal = metaMensal;
            configuracoes.comissaoPercentual = comissao;
            
            salvarDados();
            atualizarDashboard();
            mostrarNotificacao('Configurações salvas com sucesso!', 'sucesso');
        }
        
        function carregarConfiguracoes() {
            document.getElementById('metaMensalInput').value = configuracoes.metaMensal;
            document.getElementById('comissaoPercentual').value = configuracoes.comissaoPercentual;
            
            // Aplicar tema salvo
            if (configuracoes.tema === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle i').className = 'fas fa-sun';
            }
        }
        
        function exportarDados() {
            const dadosCompletos = {
                servicos: servicos,
                estoque: estoque,
                configuracoes: configuracoes,
                dataExportacao: new Date().toISOString()
            };
            
            const dadosJSON = JSON.stringify(dadosCompletos, null, 2);
            const blob = new Blob([dadosJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_controlvendas_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarNotificacao('Dados exportados com sucesso!', 'sucesso');
        }
        
        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = event => {
                    try {
                        const dados = JSON.parse(event.target.result);
                        
                        if (confirm('Isso substituirá todos os dados atuais. Continuar?')) {
                            servicos = dados.servicos || [];
                            estoque = dados.estoque || [];
                            configuracoes = { ...configuracoes, ...dados.configuracoes };
                            
                            salvarDados();
                            checkInitializers();
                            mostrarNotificacao('Dados importados com sucesso!', 'sucesso');
                        }
                    } catch (error) {
                        mostrarNotificacao('Erro ao importar dados. Arquivo inválido.', 'erro');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function criarBackupAutomatico() {
            localStorage.setItem('controlVendas_backup', JSON.stringify({
                servicos: servicos,
                estoque: estoque,
                configuracoes: configuracoes,
                dataBackup: new Date().toISOString()
            }));
            
            document.getElementById('ultimoBackup').textContent = new Date().toLocaleString('pt-BR');
            mostrarNotificacao('Backup automático criado com sucesso!', 'sucesso');
        }

        // ========================================
        // INICIALIZAÇÃO
        // ========================================

        function checkInitializers() {
            carregarDados();
            atualizarDashboard();
            document.getElementById('dataInicio').value = obterDataHojeISO();
            carregarConfiguracoes();

            // Se for o primeiro acesso, cria dados de exemplo
            if (servicos.length === 0 && localStorage.getItem('controlVendas_servicos') === null) {
                criarDadosExemplo();
            }
            
            // Verificar último backup
            const backup = localStorage.getItem('controlVendas_backup');
            if (backup) {
                const dados = JSON.parse(backup);
                document.getElementById('ultimoBackup').textContent = new Date(dados.dataBackup).toLocaleString('pt-BR');
            }
            
            // Abre o dashboard por padrão
            abrirTab('dashboard');
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkInitializers();
            
            // Configura data mínima para os date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.max = today;
            });
            
            // Atalhos de teclado
            document.addEventListener('keydown', function(e) {
                // Ctrl+S para salvar
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const tabAtiva = document.querySelector('.tab-content.active').id;
                    
                    if (tabAtiva === 'servicos') {
                        if (document.getElementById('btnSalvarEdicao').style.display !== 'none') {
                            salvarEdicaoServico();
                        } else {
                            adicionarServico();
                        }
                    }
                }
                
                // Ctrl+E para exportar
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportarDados();
                }
            });
            
            // Fechar menu mobile ao clicar fora
            document.addEventListener('click', function(e) {
                const nav = document.getElementById('main-nav');
                const toggle = document.querySelector('.mobile-menu-toggle');
                
                if (nav.classList.contains('active') && 
                    !nav.contains(e.target) && 
                    !toggle.contains(e.target)) {
                    nav.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
